<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="./_next/static/css/8336ab73ef3a5f12.css" as="style"/><link rel="stylesheet" href="./_next/static/css/8336ab73ef3a5f12.css" data-n-g=""/><link rel="preload" href="./_next/static/css/d182a84034029c2d.css" as="style"/><link rel="stylesheet" href="./_next/static/css/d182a84034029c2d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="./_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="./_next/static/chunks/webpack-e50e9853db18b759.js" defer=""></script><script src="./_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="./_next/static/chunks/main-97927b8cd08b2c1f.js" defer=""></script><script src="./_next/static/chunks/pages/_app-d544170465216a6e.js" defer=""></script><script src="./_next/static/chunks/175675d1-1434f301c5e774f6.js" defer=""></script><script src="./_next/static/chunks/113-32fd8191b6bcd6c8.js" defer=""></script><script src="./_next/static/chunks/pages/_articles/%5B...articleId%5D-0d32ee859ee9a545.js" defer=""></script><script src="./_next/static/zP62Tgr83z9NsPYXpawDP/_buildManifest.js" defer=""></script><script src="./_next/static/zP62Tgr83z9NsPYXpawDP/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="Layout_container__K9hpm"><nav class="p-6 border border-r-2"><div class="flex flex-col items-center"><img src="/logo.png" width="100" height="100"/><span class="text-3xl font-semibold">Tal Glanzman</span><span class="text-lg">v0</span></div><div class="mt-6"><ul><li><a href="/">Home</a></li><details><summary>Advanced CS</summary><ul class="ml-4"><li><a href="/_articles/advanced-cs/linear-programming/">Linear Programming</a></li><li><a href="/_articles/advanced-cs/expanders/">Expanders</a></li></ul></details><li><a href="/_articles/about/">About</a></li></ul></div></nav><header><div class=" p-2 flex flex-col items-center"><span class="text-4xl font-semibold">Simple on-prem Kuberenetes cluster</span><span class="text-lg"></span></div></header><main><div class="text-sm m-4"><div><span>Categories<!-- -->: </span><span><span class="inline-block"><a href="/_categories/Kubernetes/">Kubernetes</a></span></span></div><div><span>Tags<!-- -->: </span><span><span class="inline-block"><a href="/_tags/Kubernetes/">Kubernetes</a></span></span></div></div><div class="ArticleContent_md__52PoF"><!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <h1>Kubes</h1>
    <p>Deploy a kubernetes cluster.</p>
    <p>We will setup a simple kubernetes cluster will describe the concepts and process.</p>
    <p>The OS on all nodes is debian bullseye - I specifically executing this using vagrant's box <code>debian/bullseye64</code>.</p>
    <p>To document the steps we will provide bash script snippets for now. But, the goal is to provide configuration files content for something like ansible or chef.</p>
    <h2>Container runtime</h2>
    <p>Kubernetes is an orchestration infrastructure and does not provide any containerization - It relies on a different containarization platform, a.k.a the <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">Container Runtime</a>.</p>
    <p>We will use <a href="https://www.docker.com/">docker</a>. Let's install it by following the documentation <a href="https://docs.docker.com/engine/install/debian/">Here</a>.</p>
    <pre><code class="hljs language-basic">sudo apt-<span class="hljs-keyword">get</span> <span class="hljs-comment">remove docker docker-engine docker.io containerd runc</span>

sudo apt-<span class="hljs-keyword">get</span> update
sudo apt-<span class="hljs-keyword">get</span> install ca-certificates curl gnupg lsb-release

curl -fsSL https://download.docker.<span class="hljs-keyword">com</span>/linux/debian/gpg | sudo gpg --dearmor -o /<span class="hljs-keyword">usr</span>/share/keyrings/docker-archive-keyring.gpg

echo \
  <span class="hljs-string">"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable"</span> | sudo tee /etc/apt/sources.<span class="hljs-keyword">list</span>.d/docker.<span class="hljs-keyword">list</span> > /dev/null

sudo apt-<span class="hljs-keyword">get</span> update
sudo apt-<span class="hljs-keyword">get</span> install docker-ce docker-ce-cli containerd.io
</code></pre>
    <p>Another thing to do is docker to utilize systemd for cgroup management (You can read more about it in the container runtimes documentation). To apply this setting we need to edit docker's configuration. There are multiple to do so, for example - edit systemd's service that initiates docker. Another approach is to edit docker's global configuration file which is at <code>/etc/docker/daemon.json</code>. Hence, edit (create if missing) the mentioned file and add</p>
    <pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
    ... other configurations
    <span class="hljs-attr">"exec-opts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"native.cgroupdriver=systemd"</span><span class="hljs-punctuation">,</span> ... more exec opts if exists<span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
    <p>Once done, reboot docker by running <code>sudo systemctl restart docker</code></p>
    <h2>Kube Components</h2>
    <p>We will not rely on the package manager to install the components.</p>
    <p>Define the relevant variables</p>
    <blockquote>
      <p>Note that the cni directory does not include the version! Later we will install a network plugin, it'll be in the same directory</p>
    </blockquote>
    <pre><code class="hljs language-bash">ARCH=<span class="hljs-string">"amd64"</span>
CNI_VERSION=<span class="hljs-string">"v0.8.2"</span>
CNI_DIR=<span class="hljs-string">"/opt/cni/bin"</span>
CRICTL_VERSION=<span class="hljs-string">"v1.23.0"</span>
CRICTL_DIR=<span class="hljs-string">"/opt/cri/<span class="hljs-variable">$CRICTL_VERSION</span>/bin"</span>
KUBERNETES_VERSION=<span class="hljs-string">"v1.23.3"</span>
KUBERNETES_DIR=<span class="hljs-string">"/opt/kubernetes/<span class="hljs-variable">$KUBERNETES_VERSION</span>"</span>

<span class="hljs-comment"># Install [CNI](https://www.cni.dev/)</span>

sudo <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$CNI_DIR</span>
curl -L <span class="hljs-string">"https://github.com/containernetworking/plugins/releases/download/<span class="hljs-variable">${CNI_VERSION}</span>/cni-plugins-linux-<span class="hljs-variable">${ARCH}</span>-<span class="hljs-variable">${CNI_VERSION}</span>.tgz"</span> | sudo tar -C <span class="hljs-variable">$CNI_DIR</span> -xz

<span class="hljs-comment"># Install [CRI](https://kubernetes.io/docs/concepts/architecture/cri/)</span>

sudo <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$CRICTL_DIR</span>
curl -L <span class="hljs-string">"https://github.com/kubernetes-sigs/cri-tools/releases/download/<span class="hljs-variable">${CRICTL_VERSION}</span>/crictl-<span class="hljs-variable">${CRICTL_VERSION}</span>-linux-<span class="hljs-variable">${ARCH}</span>.tar.gz"</span> | sudo tar -C <span class="hljs-variable">$CRICTL_DIR</span> -xz

<span class="hljs-comment"># Install Kube components</span>

sudo <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$KUBERNETES_DIR</span>
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$KUBERNETES_DIR</span>
<span class="hljs-keyword">for</span> component <span class="hljs-keyword">in</span> kubeadm kubectl kubelet; <span class="hljs-keyword">do</span>
  sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/<span class="hljs-variable">$KUBERNETES_VERSION</span>/bin/linux/<span class="hljs-variable">$ARCH</span>/<span class="hljs-variable">$component</span>
  sudo <span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">$component</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># and services</span>

RELEASE_VERSION=<span class="hljs-string">"v0.4.0"</span>
curl -sSL <span class="hljs-string">"https://raw.githubusercontent.com/kubernetes/release/<span class="hljs-variable">${RELEASE_VERSION}</span>/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service"</span> | sed <span class="hljs-string">"s:/usr/bin:<span class="hljs-variable">${KUBERNETES_DIR}</span>:g"</span> | sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/kubelet.service
sudo <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/kubelet.service.d
curl -sSL <span class="hljs-string">"https://raw.githubusercontent.com/kubernetes/release/<span class="hljs-variable">${RELEASE_VERSION}</span>/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf"</span> | sed <span class="hljs-string">"s:/usr/bin:<span class="hljs-variable">${KUBERNETES_DIR}</span>:g"</span> | sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre>
    <p>enable, and start kubelet</p>
    <pre><code class="hljs language-pgsql">sudo systemctl <span class="hljs-keyword">enable</span> <span class="hljs-comment">--now kubelet</span>
</code></pre>
    <h2>Initialization</h2>
    <p>Install prerequesites for kubeadm</p>
    <pre><code class="hljs language-properties"><span class="hljs-attr">sudo</span> <span class="hljs-string">apt-get update </span>
<span class="hljs-attr">sudo</span> <span class="hljs-string">apt install ethtool socat conntrack</span>
</code></pre>
    <p>Create an update alternative</p>
    <pre><code class="hljs language-awk">sudo update-alternatives --install <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/kubeadm kubeadm $KUBERNETES_DIR/</span>kubeadm <span class="hljs-number">100</span>
sudo update-alternatives --install <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/kubelet kubelet $KUBERNETES_DIR/</span>kubelet <span class="hljs-number">100</span>
sudo update-alternatives --install <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/kubectl kubectl $KUBERNETES_DIR/</span>kubectl <span class="hljs-number">100</span>
</code></pre>
    <p>Run @controlplane</p>
    <blockquote>
      <p>TODO: load balancer, hostnames</p>
    </blockquote>
    <p>Initialize configuration such that the network is 10.10.0.0/16</p>
    <pre><code class="hljs language-apache"><span class="hljs-attribute">sudo</span> kubeadm init --pod-network-cidr <span class="hljs-number">10.10.0.0</span>/<span class="hljs-number">16</span> --apiserver-advertise-address {ip}
</code></pre>
    <p>For documentation, you should see something like</p>
    <pre><code class="hljs language-pgsql">Your Kubernetes control-plane has initialized successfully!

<span class="hljs-keyword">To</span> <span class="hljs-keyword">start</span> <span class="hljs-keyword">using</span> your <span class="hljs-keyword">cluster</span>, you need <span class="hljs-keyword">to</span> run the <span class="hljs-keyword">following</span> <span class="hljs-keyword">as</span> a regular <span class="hljs-keyword">user</span>:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/<span class="hljs-keyword">admin</span>.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, <span class="hljs-keyword">if</span> you are the root <span class="hljs-keyword">user</span>, you can run:

  export KUBECONFIG=/etc/kubernetes/<span class="hljs-keyword">admin</span>.conf

You should now deploy a pod network <span class="hljs-keyword">to</span> the <span class="hljs-keyword">cluster</span>.
Run "kubectl apply -f [podnetwork].yaml" <span class="hljs-keyword">with</span> one <span class="hljs-keyword">of</span> the <span class="hljs-keyword">options</span> listed at:
  https://kubernetes.io/docs/concepts/<span class="hljs-keyword">cluster</span>-administration/addons/

<span class="hljs-keyword">Then</span> you can <span class="hljs-keyword">join</span> <span class="hljs-keyword">any</span> number <span class="hljs-keyword">of</span> worker nodes <span class="hljs-keyword">by</span> running the <span class="hljs-keyword">following</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">as</span> root:

kubeadm <span class="hljs-keyword">join</span> <span class="hljs-number">192.168</span><span class="hljs-number">.121</span><span class="hljs-number">.210</span>:<span class="hljs-number">6443</span> <span class="hljs-comment">--token clns4a.b29f6anjipygy0e2 \</span>
	<span class="hljs-comment">--discovery-token-ca-cert-hash sha256:833f599cc9ab27eb5010c499e9c77e8e3263fb991d8e9e78ef187ba97e1efb59</span>
</code></pre>
    <p>Do as it says, run</p>
    <pre><code class="hljs language-bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube
sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config
sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config
</code></pre>
    <p>We will use <a href="https://kubernetes.io/docs/tasks/administer-cluster/network-policy-provider/weave-network-policy/">Weave Net</a> as a network plugin</p>
    <pre><code class="hljs language-powershell">kubectl apply <span class="hljs-operator">-f</span> <span class="hljs-string">"https://cloud.weave.works/k8s/net?k8s-version=<span class="hljs-variable">$</span>(kubectl version | base64 | tr -d '\n')"</span>
</code></pre>
  </body>
</html>
</div></main><footer><div class=" border-t-2 p-4 flex flex-row justify-center items-center space-x-4"><a href="https://github.com/tglanz"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a href="https://il.linkedin.com/in/tal-glanzman"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"id":"kubernetes/simple-on-prem-cluster","filePath":"/home/runner/work/tglanz.github.io/tglanz.github.io/content/kubernetes/simple-on-prem-cluster.md","metadata":{"title":"Simple on-prem Kuberenetes cluster","description":null,"permalink":null,"priority":0,"tags":["Kubernetes"],"categories":["Kubernetes"]},"content":{"raw":"\n# Kubes\n\nDeploy a kubernetes cluster.\n\nWe will setup a simple kubernetes cluster will describe the concepts and process.\n\nThe OS on all nodes is debian bullseye - I specifically executing this using vagrant's box ```debian/bullseye64```.\n\nTo document the steps we will provide bash script snippets for now. But, the goal is to provide configuration files content for something like ansible or chef.\n\n## Container runtime\n\nKubernetes is an orchestration infrastructure and does not provide any containerization - It relies on a different containarization platform, a.k.a the [Container Runtime](https://kubernetes.io/docs/setup/production-environment/container-runtimes/).\n\nWe will use [docker](https://www.docker.com/). Let's install it by following the documentation [Here](https://docs.docker.com/engine/install/debian/).\n\n```\nsudo apt-get remove docker docker-engine docker.io containerd runc\n\nsudo apt-get update\nsudo apt-get install ca-certificates curl gnupg lsb-release\n\ncurl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n\necho \\\n  \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \\\n  $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list \u003e /dev/null\n\nsudo apt-get update\nsudo apt-get install docker-ce docker-ce-cli containerd.io\n```\n\nAnother thing to do is docker to utilize systemd for cgroup management (You can read more about it in the container runtimes documentation). To apply this setting we need to edit docker's configuration. There are multiple to do so, for example - edit systemd's service that initiates docker. Another approach is to edit docker's global configuration file which is at ```/etc/docker/daemon.json```. Hence, edit (create if missing) the mentioned file and add\n\n```json\n{\n    ... other configurations\n    \"exec-opts\": [\"native.cgroupdriver=systemd\", ... more exec opts if exists]\n}\n```\n\nOnce done, reboot docker by running ```sudo systemctl restart docker```\n\n## Kube Components\n\nWe will not rely on the package manager to install the components.\n\nDefine the relevant variables\n\n\u003e Note that the cni directory does not include the version! Later we will install a network plugin, it'll be in the same directory\n\n```\nARCH=\"amd64\"\nCNI_VERSION=\"v0.8.2\"\nCNI_DIR=\"/opt/cni/bin\"\nCRICTL_VERSION=\"v1.23.0\"\nCRICTL_DIR=\"/opt/cri/$CRICTL_VERSION/bin\"\nKUBERNETES_VERSION=\"v1.23.3\"\nKUBERNETES_DIR=\"/opt/kubernetes/$KUBERNETES_VERSION\"\n\n# Install [CNI](https://www.cni.dev/)\n\nsudo mkdir -p $CNI_DIR\ncurl -L \"https://github.com/containernetworking/plugins/releases/download/${CNI_VERSION}/cni-plugins-linux-${ARCH}-${CNI_VERSION}.tgz\" | sudo tar -C $CNI_DIR -xz\n\n# Install [CRI](https://kubernetes.io/docs/concepts/architecture/cri/)\n\nsudo mkdir -p $CRICTL_DIR\ncurl -L \"https://github.com/kubernetes-sigs/cri-tools/releases/download/${CRICTL_VERSION}/crictl-${CRICTL_VERSION}-linux-${ARCH}.tar.gz\" | sudo tar -C $CRICTL_DIR -xz\n\n# Install Kube components\n\nsudo mkdir -p $KUBERNETES_DIR\ncd $KUBERNETES_DIR\nfor component in kubeadm kubectl kubelet; do\n  sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/$KUBERNETES_VERSION/bin/linux/$ARCH/$component\n  sudo chmod +x $component\ndone\n\n# and services\n\nRELEASE_VERSION=\"v0.4.0\"\ncurl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service\" | sed \"s:/usr/bin:${KUBERNETES_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service\nsudo mkdir -p /etc/systemd/system/kubelet.service.d\ncurl -sSL \"https://raw.githubusercontent.com/kubernetes/release/${RELEASE_VERSION}/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf\" | sed \"s:/usr/bin:${KUBERNETES_DIR}:g\" | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n```\n\nenable, and start kubelet\n\n```\nsudo systemctl enable --now kubelet\n```\n\n## Initialization\n\nInstall prerequesites for kubeadm\n\n```\nsudo apt-get update \nsudo apt install ethtool socat conntrack\n```\n\nCreate an update alternative\n\n```\nsudo update-alternatives --install /usr/bin/kubeadm kubeadm $KUBERNETES_DIR/kubeadm 100\nsudo update-alternatives --install /usr/bin/kubelet kubelet $KUBERNETES_DIR/kubelet 100\nsudo update-alternatives --install /usr/bin/kubectl kubectl $KUBERNETES_DIR/kubectl 100\n```\n\nRun @controlplane\n\n\u003e TODO: load balancer, hostnames\n\nInitialize configuration such that the network is 10.10.0.0/16\n\n```\nsudo kubeadm init --pod-network-cidr 10.10.0.0/16 --apiserver-advertise-address {ip}\n```\n\nFor documentation, you should see something like\n\n```\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 192.168.121.210:6443 --token clns4a.b29f6anjipygy0e2 \\\n\t--discovery-token-ca-cert-hash sha256:833f599cc9ab27eb5010c499e9c77e8e3263fb991d8e9e78ef187ba97e1efb59\n```\n\nDo as it says, run\n\n```\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\nWe will use [Weave Net](https://kubernetes.io/docs/tasks/administer-cluster/network-policy-provider/weave-network-policy/) as a network plugin\n\n```\nkubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n```\n","html":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n  \u003chead\u003e\n    \u003cmeta charset=\"utf-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1\"\u003e\n  \u003c/head\u003e\n  \u003cbody\u003e\n    \u003ch1\u003eKubes\u003c/h1\u003e\n    \u003cp\u003eDeploy a kubernetes cluster.\u003c/p\u003e\n    \u003cp\u003eWe will setup a simple kubernetes cluster will describe the concepts and process.\u003c/p\u003e\n    \u003cp\u003eThe OS on all nodes is debian bullseye - I specifically executing this using vagrant's box \u003ccode\u003edebian/bullseye64\u003c/code\u003e.\u003c/p\u003e\n    \u003cp\u003eTo document the steps we will provide bash script snippets for now. But, the goal is to provide configuration files content for something like ansible or chef.\u003c/p\u003e\n    \u003ch2\u003eContainer runtime\u003c/h2\u003e\n    \u003cp\u003eKubernetes is an orchestration infrastructure and does not provide any containerization - It relies on a different containarization platform, a.k.a the \u003ca href=\"https://kubernetes.io/docs/setup/production-environment/container-runtimes/\"\u003eContainer Runtime\u003c/a\u003e.\u003c/p\u003e\n    \u003cp\u003eWe will use \u003ca href=\"https://www.docker.com/\"\u003edocker\u003c/a\u003e. Let's install it by following the documentation \u003ca href=\"https://docs.docker.com/engine/install/debian/\"\u003eHere\u003c/a\u003e.\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-basic\"\u003esudo apt-\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003eremove docker docker-engine docker.io containerd runc\u003c/span\u003e\n\nsudo apt-\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e update\nsudo apt-\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e install ca-certificates curl gnupg lsb-release\n\ncurl -fsSL https://download.docker.\u003cspan class=\"hljs-keyword\"\u003ecom\u003c/span\u003e/linux/debian/gpg | sudo gpg --dearmor -o /\u003cspan class=\"hljs-keyword\"\u003eusr\u003c/span\u003e/share/keyrings/docker-archive-keyring.gpg\n\necho \\\n  \u003cspan class=\"hljs-string\"\u003e\"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \\\n  $(lsb_release -cs) stable\"\u003c/span\u003e | sudo tee /etc/apt/sources.\u003cspan class=\"hljs-keyword\"\u003elist\u003c/span\u003e.d/docker.\u003cspan class=\"hljs-keyword\"\u003elist\u003c/span\u003e \u003e /dev/null\n\nsudo apt-\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e update\nsudo apt-\u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e install docker-ce docker-ce-cli containerd.io\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eAnother thing to do is docker to utilize systemd for cgroup management (You can read more about it in the container runtimes documentation). To apply this setting we need to edit docker's configuration. There are multiple to do so, for example - edit systemd's service that initiates docker. Another approach is to edit docker's global configuration file which is at \u003ccode\u003e/etc/docker/daemon.json\u003c/code\u003e. Hence, edit (create if missing) the mentioned file and add\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n    ... other configurations\n    \u003cspan class=\"hljs-attr\"\u003e\"exec-opts\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\"native.cgroupdriver=systemd\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e ... more exec opts if exists\u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eOnce done, reboot docker by running \u003ccode\u003esudo systemctl restart docker\u003c/code\u003e\u003c/p\u003e\n    \u003ch2\u003eKube Components\u003c/h2\u003e\n    \u003cp\u003eWe will not rely on the package manager to install the components.\u003c/p\u003e\n    \u003cp\u003eDefine the relevant variables\u003c/p\u003e\n    \u003cblockquote\u003e\n      \u003cp\u003eNote that the cni directory does not include the version! Later we will install a network plugin, it'll be in the same directory\u003c/p\u003e\n    \u003c/blockquote\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eARCH=\u003cspan class=\"hljs-string\"\u003e\"amd64\"\u003c/span\u003e\nCNI_VERSION=\u003cspan class=\"hljs-string\"\u003e\"v0.8.2\"\u003c/span\u003e\nCNI_DIR=\u003cspan class=\"hljs-string\"\u003e\"/opt/cni/bin\"\u003c/span\u003e\nCRICTL_VERSION=\u003cspan class=\"hljs-string\"\u003e\"v1.23.0\"\u003c/span\u003e\nCRICTL_DIR=\u003cspan class=\"hljs-string\"\u003e\"/opt/cri/\u003cspan class=\"hljs-variable\"\u003e$CRICTL_VERSION\u003c/span\u003e/bin\"\u003c/span\u003e\nKUBERNETES_VERSION=\u003cspan class=\"hljs-string\"\u003e\"v1.23.3\"\u003c/span\u003e\nKUBERNETES_DIR=\u003cspan class=\"hljs-string\"\u003e\"/opt/kubernetes/\u003cspan class=\"hljs-variable\"\u003e$KUBERNETES_VERSION\u003c/span\u003e\"\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# Install [CNI](https://www.cni.dev/)\u003c/span\u003e\n\nsudo \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"hljs-variable\"\u003e$CNI_DIR\u003c/span\u003e\ncurl -L \u003cspan class=\"hljs-string\"\u003e\"https://github.com/containernetworking/plugins/releases/download/\u003cspan class=\"hljs-variable\"\u003e${CNI_VERSION}\u003c/span\u003e/cni-plugins-linux-\u003cspan class=\"hljs-variable\"\u003e${ARCH}\u003c/span\u003e-\u003cspan class=\"hljs-variable\"\u003e${CNI_VERSION}\u003c/span\u003e.tgz\"\u003c/span\u003e | sudo tar -C \u003cspan class=\"hljs-variable\"\u003e$CNI_DIR\u003c/span\u003e -xz\n\n\u003cspan class=\"hljs-comment\"\u003e# Install [CRI](https://kubernetes.io/docs/concepts/architecture/cri/)\u003c/span\u003e\n\nsudo \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"hljs-variable\"\u003e$CRICTL_DIR\u003c/span\u003e\ncurl -L \u003cspan class=\"hljs-string\"\u003e\"https://github.com/kubernetes-sigs/cri-tools/releases/download/\u003cspan class=\"hljs-variable\"\u003e${CRICTL_VERSION}\u003c/span\u003e/crictl-\u003cspan class=\"hljs-variable\"\u003e${CRICTL_VERSION}\u003c/span\u003e-linux-\u003cspan class=\"hljs-variable\"\u003e${ARCH}\u003c/span\u003e.tar.gz\"\u003c/span\u003e | sudo tar -C \u003cspan class=\"hljs-variable\"\u003e$CRICTL_DIR\u003c/span\u003e -xz\n\n\u003cspan class=\"hljs-comment\"\u003e# Install Kube components\u003c/span\u003e\n\nsudo \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"hljs-variable\"\u003e$KUBERNETES_DIR\u003c/span\u003e\n\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e \u003cspan class=\"hljs-variable\"\u003e$KUBERNETES_DIR\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e component \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e kubeadm kubectl kubelet; \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e\n  sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/\u003cspan class=\"hljs-variable\"\u003e$KUBERNETES_VERSION\u003c/span\u003e/bin/linux/\u003cspan class=\"hljs-variable\"\u003e$ARCH\u003c/span\u003e/\u003cspan class=\"hljs-variable\"\u003e$component\u003c/span\u003e\n  sudo \u003cspan class=\"hljs-built_in\"\u003echmod\u003c/span\u003e +x \u003cspan class=\"hljs-variable\"\u003e$component\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003edone\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# and services\u003c/span\u003e\n\nRELEASE_VERSION=\u003cspan class=\"hljs-string\"\u003e\"v0.4.0\"\u003c/span\u003e\ncurl -sSL \u003cspan class=\"hljs-string\"\u003e\"https://raw.githubusercontent.com/kubernetes/release/\u003cspan class=\"hljs-variable\"\u003e${RELEASE_VERSION}\u003c/span\u003e/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service\"\u003c/span\u003e | sed \u003cspan class=\"hljs-string\"\u003e\"s:/usr/bin:\u003cspan class=\"hljs-variable\"\u003e${KUBERNETES_DIR}\u003c/span\u003e:g\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/systemd/system/kubelet.service\nsudo \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p /etc/systemd/system/kubelet.service.d\ncurl -sSL \u003cspan class=\"hljs-string\"\u003e\"https://raw.githubusercontent.com/kubernetes/release/\u003cspan class=\"hljs-variable\"\u003e${RELEASE_VERSION}\u003c/span\u003e/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf\"\u003c/span\u003e | sed \u003cspan class=\"hljs-string\"\u003e\"s:/usr/bin:\u003cspan class=\"hljs-variable\"\u003e${KUBERNETES_DIR}\u003c/span\u003e:g\"\u003c/span\u003e | sudo \u003cspan class=\"hljs-built_in\"\u003etee\u003c/span\u003e /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eenable, and start kubelet\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-pgsql\"\u003esudo systemctl \u003cspan class=\"hljs-keyword\"\u003eenable\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e--now kubelet\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n    \u003ch2\u003eInitialization\u003c/h2\u003e\n    \u003cp\u003eInstall prerequesites for kubeadm\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-properties\"\u003e\u003cspan class=\"hljs-attr\"\u003esudo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapt-get update \u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003esudo\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eapt install ethtool socat conntrack\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eCreate an update alternative\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-awk\"\u003esudo update-alternatives --install \u003cspan class=\"hljs-regexp\"\u003e/usr/\u003c/span\u003ebin\u003cspan class=\"hljs-regexp\"\u003e/kubeadm kubeadm $KUBERNETES_DIR/\u003c/span\u003ekubeadm \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e\nsudo update-alternatives --install \u003cspan class=\"hljs-regexp\"\u003e/usr/\u003c/span\u003ebin\u003cspan class=\"hljs-regexp\"\u003e/kubelet kubelet $KUBERNETES_DIR/\u003c/span\u003ekubelet \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e\nsudo update-alternatives --install \u003cspan class=\"hljs-regexp\"\u003e/usr/\u003c/span\u003ebin\u003cspan class=\"hljs-regexp\"\u003e/kubectl kubectl $KUBERNETES_DIR/\u003c/span\u003ekubectl \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eRun @controlplane\u003c/p\u003e\n    \u003cblockquote\u003e\n      \u003cp\u003eTODO: load balancer, hostnames\u003c/p\u003e\n    \u003c/blockquote\u003e\n    \u003cp\u003eInitialize configuration such that the network is 10.10.0.0/16\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-apache\"\u003e\u003cspan class=\"hljs-attribute\"\u003esudo\u003c/span\u003e kubeadm init --pod-network-cidr \u003cspan class=\"hljs-number\"\u003e10.10.0.0\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e --apiserver-advertise-address {ip}\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eFor documentation, you should see something like\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-pgsql\"\u003eYour Kubernetes control-plane has initialized successfully!\n\n\u003cspan class=\"hljs-keyword\"\u003eTo\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estart\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eusing\u003c/span\u003e your \u003cspan class=\"hljs-keyword\"\u003ecluster\u003c/span\u003e, you need \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e run the \u003cspan class=\"hljs-keyword\"\u003efollowing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e a regular \u003cspan class=\"hljs-keyword\"\u003euser\u003c/span\u003e:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/\u003cspan class=\"hljs-keyword\"\u003eadmin\u003c/span\u003e.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e you are the root \u003cspan class=\"hljs-keyword\"\u003euser\u003c/span\u003e, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/\u003cspan class=\"hljs-keyword\"\u003eadmin\u003c/span\u003e.conf\n\nYou should now deploy a pod network \u003cspan class=\"hljs-keyword\"\u003eto\u003c/span\u003e the \u003cspan class=\"hljs-keyword\"\u003ecluster\u003c/span\u003e.\nRun \"kubectl apply -f [podnetwork].yaml\" \u003cspan class=\"hljs-keyword\"\u003ewith\u003c/span\u003e one \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e the \u003cspan class=\"hljs-keyword\"\u003eoptions\u003c/span\u003e listed at:\n  https://kubernetes.io/docs/concepts/\u003cspan class=\"hljs-keyword\"\u003ecluster\u003c/span\u003e-administration/addons/\n\n\u003cspan class=\"hljs-keyword\"\u003eThen\u003c/span\u003e you can \u003cspan class=\"hljs-keyword\"\u003ejoin\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eany\u003c/span\u003e number \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e worker nodes \u003cspan class=\"hljs-keyword\"\u003eby\u003c/span\u003e running the \u003cspan class=\"hljs-keyword\"\u003efollowing\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eon\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eeach\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e root:\n\nkubeadm \u003cspan class=\"hljs-keyword\"\u003ejoin\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e192.168\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.121\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e.210\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e6443\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e--token clns4a.b29f6anjipygy0e2 \\\u003c/span\u003e\n\t\u003cspan class=\"hljs-comment\"\u003e--discovery-token-ca-cert-hash sha256:833f599cc9ab27eb5010c499e9c77e8e3263fb991d8e9e78ef187ba97e1efb59\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eDo as it says, run\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube\nsudo \u003cspan class=\"hljs-built_in\"\u003ecp\u003c/span\u003e -i /etc/kubernetes/admin.conf \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube/config\nsudo \u003cspan class=\"hljs-built_in\"\u003echown\u003c/span\u003e $(\u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e -u):$(\u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e -g) \u003cspan class=\"hljs-variable\"\u003e$HOME\u003c/span\u003e/.kube/config\n\u003c/code\u003e\u003c/pre\u003e\n    \u003cp\u003eWe will use \u003ca href=\"https://kubernetes.io/docs/tasks/administer-cluster/network-policy-provider/weave-network-policy/\"\u003eWeave Net\u003c/a\u003e as a network plugin\u003c/p\u003e\n    \u003cpre\u003e\u003ccode class=\"hljs language-powershell\"\u003ekubectl apply \u003cspan class=\"hljs-operator\"\u003e-f\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"https://cloud.weave.works/k8s/net?k8s-version=\u003cspan class=\"hljs-variable\"\u003e$\u003c/span\u003e(kubectl version | base64 | tr -d '\\n')\"\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n  \u003c/body\u003e\n\u003c/html\u003e\n"}}},"__N_SSG":true},"page":"/_articles/[...articleId]","query":{"articleId":["kubernetes","simple-on-prem-cluster"]},"buildId":"zP62Tgr83z9NsPYXpawDP","assetPrefix":".","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>